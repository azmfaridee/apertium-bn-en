<?xml version="1.0" encoding="utf-8"?>
<transfer default="chunk">
  <section-def-cats>
    <def-cat n="sent">
      <cat-item tags="sent"/>
    </def-cat>
    <def-cat n="prn_subj">
      <cat-item lemma="prpers" tags="prn.subj.*"/>
      <cat-item lemma="prpers" tags="prn.*"/>
    </def-cat>
    <def-cat n="prn_ref">
      <cat-item tags="prn.ref.*"/>
    </def-cat>
    <def-cat n="verbcj">
      <cat-item tags="vblex.past"/>
      <cat-item tags="vblex.pres"/>
      <cat-item tags="vblex.past.*"/>
      <cat-item tags="vblex.pres.*"/>
    </def-cat>
    <def-cat n="art">
      <cat-item tags="det.def.*"/>
    </def-cat>
    <def-cat n="nom">
      <cat-item tags="n.*"/>
      <cat-item tags="np.*"/>
    </def-cat>
    <def-cat n="adj">
      <cat-item tags="adj"/>
      <cat-item tags="adj.*"/>
    </def-cat>
    <def-cat n="genitive">
      <cat-item tags="gen"/>
    </def-cat>
    <def-cat n="vblex">
      <cat-item tags="vblex.*"/>
    </def-cat>
    <def-cat n="vbser">
      <cat-item tags="vbser.*"/>
    </def-cat>
  </section-def-cats>

  <section-def-attrs>
    <def-attr n="a_nom">
      <attr-item tags="n"/>
      <attr-item tags="np"/>
    </def-attr>
    <def-attr n="a_prn">
      <attr-item tags="prn"/>
    </def-attr>
    <def-attr n="tipus_prn">
      <attr-item tags="ref"/>
      <attr-item tags="subj"/>
      <attr-item tags="obj"/>
      <attr-item tags="dem"/>
    </def-attr>
    <def-attr n="anim">
      <attr-item tags="an"/>
      <attr-item tags="nn"/>
      <attr-item tags="aa"/>
      <attr-item tags="el"/>
      <attr-item tags="hu"/>
    </def-attr>
    <def-attr n="gen">
      <attr-item tags="m"/>
      <attr-item tags="f"/>
      <attr-item tags="nt"/>
      <attr-item tags="mf"/>
      <attr-item tags="GD"/>
    </def-attr>
    <def-attr n="nbr">
      <attr-item tags="sg"/>
      <attr-item tags="pl"/>
      <attr-item tags="sp"/>
      <attr-item tags="ND"/>
    </def-attr>
    <def-attr n="pers">
      <attr-item tags="p1"/>
      <attr-item tags="p2"/>
      <attr-item tags="p3"/>
    </def-attr>
    <def-attr n="temps">
      <attr-item tags="pres"/>
      <attr-item tags="pres.smpl"/>
      <attr-item tags="pres.cnt"/>
      <attr-item tags="past"/>
      <attr-item tags="past.smpl"/>
      <attr-item tags="past.cnt"/>        
      <attr-item tags="inf"/>
      <!-- present indefinite? -->
      <attr-item tags="pri"/>
    </def-attr>
    
    <!-- Adjective Attributes -->
    <def-attr n="a_adj">          
      <attr-item tags="adj"/>
      <attr-item tags="adj.psint"/>
      <attr-item tags="adj.psint.sup"/>
      <attr-item tags="adj.sint.comp"/>
      <attr-item tags="adj.sint"/>
      <attr-item tags="adj.sint.sup"/>
    </def-attr>

    <!-- Vblex Attribute -->
    <def-attr n="a_vblex">
      <attr-item tags="ger"/>
    </def-attr>

  </section-def-attrs>

  <section-def-vars>
    <def-var n="number"/>
    <def-var n="case" v="&lt;nom&gt;"/>
    <def-var n="genere"/>
    <def-var n="person"/>
    <def-var n="EOS"/>
  </section-def-vars>

  <section-rules>

    <!-- Sintagmas nominales -->

    <rule comment="REGLA: NOM">
      <pattern>
        <pattern-item n="nom"/>
      </pattern>
      <action>
        <out>
          <chunk name="nom" case="caseFirstWord">
            <tags>
              <tag><lit-tag v="SN"/></tag>
              <tag><clip pos="1" side="tl" part="gen"/></tag>
              <tag><clip pos="1" side="tl" part="anim"/></tag>
              <tag><clip pos="1" side="tl" part="nbr"/></tag>
              <tag><lit-tag v="nom"/></tag>
            </tags>
            <lu>
              <clip pos="1" side="tl" part="lemh"/>
              <clip pos="1" side="tl" part="a_nom"/>
              <clip pos="1" side="tl" part="gen" link-to="2"/> 
              <clip pos="1" side="tl" part="anim" link-to="3"/> 
              <clip pos="1" side="tl" part="nbr" link-to="4"/>
              <lit-tag v="5"/>
              <clip pos="1" side="tl" part="lemq"/>
            </lu>
          </chunk>
        </out>
      </action>
    </rule>

    <!-- New rule for ADJ NOM -->
    <rule comment="RELGA: ADJ NOM">
      <pattern>
        <pattern-item n="adj"/>
        <pattern-item n="nom"/>
      </pattern>
      <action>
        <out>
          <chunk name="adj_nom" case="caseFirstWord">
            <tags>
              <tag><lit-tag v="SN"/></tag>
              <tag><clip pos="2" side="tl" part="gen"/></tag>
              <tag><clip pos="2" side="tl" part="anim"/></tag>
              <tag><clip pos="2" side="tl" part="nbr"/></tag>
              <tag><lit-tag v="nom"/></tag>
            </tags>
            <lu>
              <clip pos="1" side="tl" part="lemh"/>
              <clip pos="1" side="tl" part="a_adj"/>
              <clip pos="1" side="tl" part="gen"/>        
              <clip pos="1" side="tl" part="lemq"/>
            </lu>
            <b pos="1"/>
            <lu>
              <clip pos="2" side="tl" part="lemh"/>
              <clip pos="2" side="tl" part="a_nom"/>
              <clip pos="2" side="tl" part="gen" link-to="2"/> 
              <clip pos="2" side="tl" part="anim" link-to="3"/> 
              <clip pos="2" side="tl" part="nbr" link-to="4"/>
              <lit-tag v="5"/>
              <clip pos="2" side="tl" part="lemq"/>
            </lu>
          </chunk>
        </out>
      </action>
    </rule>

    <rule comment="RELGA: ADJ">
      <pattern>
        <pattern-item n="adj"/>
      </pattern>
      <action>
        <out>
          <chunk name="adj" case="caseFirstWord">
            <tags>
              <tag><lit-tag v="SN"/></tag>
              <tag><clip pos="1" side="tl" part="a_adj"/></tag>
              <tag><clip pos="1" side="tl" part="gen"/></tag>
            </tags>
            <lu>
              <clip pos="1" side="tl" part="lemh"/>
              <clip pos="1" side="tl" part="a_adj" link-to="2"/>
              <clip pos="1" side="tl" part="gen" link-to="3"/>
              <clip pos="1" side="tl" part="lemq"/>
            </lu>
          </chunk>
        </out>
      </action>
    </rule>

    <rule comment="REGLA: ART NOM">
      <pattern>
        <pattern-item n="art"/>
        <pattern-item n="nom"/>
      </pattern>
      <action>
        <out>
          <chunk name="nom" case="caseFirstWord">
            <tags>
              <tag><lit-tag v="SN"/></tag>
              <tag><clip pos="2" side="tl" part="gen"/></tag>
              <tag><clip pos="2" side="tl" part="anim"/></tag>
              <tag><clip pos="2" side="tl" part="nbr"/></tag>
              <tag><lit-tag v="nom"/></tag>
            </tags>
            <lu>
              <clip pos="2" side="tl" part="lemh"/>
              <clip pos="2" side="tl" part="a_nom"/>
              <clip pos="2" side="tl" part="gen" link-to="2"/> 
              <clip pos="2" side="tl" part="anim" link-to="3"/> 
              <clip pos="2" side="tl" part="nbr" link-to="4"/>
              <lit-tag v="5"/>
              <lit-tag v="def"/>
              <clip pos="2" side="tl" part="lemq"/>
            </lu>
          </chunk>
        </out>
      </action>
    </rule>


    <rule comment="REGLA: PRNSUBJ">
      <pattern>
        <pattern-item n="prn_subj"/>
      </pattern>
      <action>
        <choose>
          <when>
            <test>
              <not>
                <equal>
                  <clip pos="1" side="tl" part="tipus_prn"/>
                  <lit-tag v="dem"/>
                </equal>
              </not>
            </test>
            <choose>
              <when>
                <test>
                  <equal>
                    <clip pos="1" side="tl" part="pers"/>
                    <lit-tag v="p1"/>
                  </equal>
                </test>   
                <let>
                  <var n="person"/>
                  <clip pos="1" side="tl" part="pers"/>
                </let>
              </when>
              <when>
                <test>
                  <equal>
                    <clip pos="1" side="tl" part="pers"/>
                    <lit-tag v="p2"/>
                  </equal>
                </test>   
                <let>
                  <var n="person"/>
                  <concat>
                    <clip pos="1" side="tl" part="pers"/>
                    <lit-tag v="pol"/>
                  </concat>
                </let>
              </when>
              <otherwise>
                <let>
                  <var n="person"/>
                  <concat>
                    <clip pos="1" side="tl" part="pers"/>
                    <lit-tag v="infml"/>
                  </concat>
                </let>
              </otherwise>  
            </choose>
            <let>
              <clip pos="1" side="tl" part="pers"/>
              <var n="person"/>
            </let>
          </when>
        </choose>
        <out>
          <chunk name="prnsubj" case="caseFirstWord">
            <tags>
              <tag><lit-tag v="SN"/></tag>
              <tag><clip pos="1" side="tl" part="gen"/></tag>
              <tag><clip pos="1" side="tl" part="nbr"/></tag>
              <tag><lit-tag v="nom"/></tag>
            </tags>
            <lu>
              <clip pos="1" side="tl" part="whole"/>
            </lu>
          </chunk>
        </out>
      </action>
    </rule>

    <rule comment="REGLA: PRNREF">
      <pattern>
        <pattern-item n="prn_ref"/>
      </pattern>
      <action>
        <out>
          <chunk name="prnref" case="caseFirstWord">
            <tags>
              <tag><lit-tag v="SN"/></tag>
              <tag><clip pos="1" side="tl" part="gen"/></tag>
              <tag><clip pos="1" side="tl" part="nbr"/></tag>
              <tag><var n="case"/></tag>
            </tags>
            <lu>
              <clip pos="1" side="tl" part="lemh"/>
              <clip pos="1" side="tl" part="a_prn"/>
              <clip pos="1" side="tl" part="tipus_prn"/>
              <clip pos="1" side="tl" part="pers"/>
              <clip pos="1" side="tl" part="gen"/>
              <clip pos="1" side="tl" part="nbr"/>
              <lit-tag v="4"/>
              <clip pos="1" side="tl" part="lemq"/>
            </lu>
          </chunk>
        </out>
      </action>
    </rule>


    <rule comment="REGLA: VBSER VBLEX">
      <pattern>
        <pattern-item n="vbser"/>
        <pattern-item n="vblex"/>
      </pattern>
      <action>

        <choose>
          <when>
            <test>
              <equal> 
                <!-- en part has pri to denote the present, bn uses pres -->
                <clip pos="1" side="sl" part="temps"/>
                <lit-tag v="pri"/>
              </equal>
            </test>
            <let>
                <!-- replace 'pri' with 'pres' -->
                <clip pos="1" side="tl" part="temps"/>
                <lit-tag v="pres"/>
            </let>
          </when>
        </choose>

        <choose>
          <when>
            <test>
              <equal>
                <!-- if the verb has gerund tag -->
                <clip pos="2" side="sl" part="a_vblex"/>
                <lit-tag v="ger"/>
              </equal>
            </test>
            <let>
              <!-- add cnt tag -->
              <clip pos="1" side="tl" part="temps"/>
              <concat>
                <clip pos="1" side="tl" part="temps"/>
                <lit-tag v="cnt"/>
              </concat>
            </let>
          </when>
        </choose>

        <out>
          <chunk name="verbcj" case="caseFirstWord">
            <tags>
              <tag><lit-tag v="SV"/></tag>
              <tag><clip pos="1" side="tl" part="temps"/></tag>
              <tag><var n="person"/></tag>
            </tags>
            <lu>
              <clip pos="2" side="tl" part="lemh"/>
              <lit-tag v="vblex"/>
              <clip pos="1" side="tl" part="temps" link-to="2"/>
              <clip pos="1" side="tl" part="temps" link-to="3"/>
              <clip pos="1" side="tl" part="temps" link-to="4"/>
              <clip pos="2" side="tl" part="lemq"/>
            </lu>
          </chunk>
        </out>
      </action>
   </rule>

    <rule comment="REGLA: VERB CONJ">
      <pattern>
        <pattern-item n="verbcj"/>
      </pattern>
      <action>
        <choose>

          <!-- Condition for present indefinite -->
          <when>
            <test>
              <equal> 
                <clip pos="1" side="tl" part="temps"/>
                <lit-tag v="pres"/>
              </equal>
            </test>
            <let>
              <clip pos="1" side="tl" part="temps"/>
              <concat>
                <clip pos="1" side="tl" part="temps"/>
                <lit-tag v="smpl"/>
              </concat>
            </let>
          </when>

          <!-- Condition for past indefinitie -->
          <when>
            <test>
              <equal> 
                <clip pos="1" side="tl" part="temps"/>
                <lit-tag v="past"/>
              </equal>
            </test>
            <let>
              <clip pos="1" side="tl" part="temps"/>
              <concat>
                <clip pos="1" side="tl" part="temps"/>
                <lit-tag v="smpl"/>
              </concat>
            </let>
          </when>
        </choose>

        <!-- Add person tag -->
        <let>
          <clip pos="1" side="tl" part="temps"/>
          <concat>
            <clip pos="1" side="tl" part="temps"/>
            <var n="person"/>
          </concat>
        </let>

        <!-- Actual output -->
        <out>
          <chunk name="verbcj" case="caseFirstWord">
            <tags>
              <tag><lit-tag v="SV"/></tag>
              <tag><clip pos="1" side="tl" part="temps"/></tag>
            </tags>
            <lu>
              <clip pos="1" side="tl" part="whole"/>
            </lu>
          </chunk>
        </out>
      </action>
    </rule>

    <rule>
<!-- REGLA: reset variables-->
      <pattern>
        <pattern-item n="sent"/>
      </pattern>
      <action>
        <let>
          <var n="number"/>
          <lit-tag v="sg"/>
        </let>
        <let>
          <var n="genere"/>
          <lit-tag v="m"/>
        </let>
        <let>
          <var n="case"/>
          <lit-tag v="nom"/>
        </let>
        <choose>
          <when>
            <test>
              <not>
                <or>
                  <equal>
                    <clip pos="1" side="sl" part="lem"/>
                    <lit v=";"/>
                  </equal>
                  <equal>
                    <clip pos="1" side="sl" part="lem"/>
                    <lit v=":"/>
                  </equal>
                </or>
              </not>
            </test>
            <let>
              <var n="EOS"/>
              <lit v="true"/>
            </let>
          </when>
        </choose>
        <out>
          <chunk name="punt">
            <tags>
              <tag>
                <lit-tag v="sent"/>
              </tag>
            </tags>
            <lu>
              <clip pos="1" side="tl" part="whole"/>
            </lu>
          </chunk>
        </out>
      </action>
   </rule>

  </section-rules>
</transfer>
